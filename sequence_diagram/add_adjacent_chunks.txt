title Thêm Chunks Từ Các Trang Lân Cận - Sequence Diagram

frame "Thêm Chunks Từ Các Trang Lân Cận"
actor Agent
boundary "AdjacentChunksService (API)" as API
control "VectorStore" as VS
database "Metadata Index" as META

Agent->API: Yêu cầu thêm chunks lân cận\n(chunks, page_range=2)
API->API: Kiểm tra chunks có rỗng không
alt Danh sách chunks rỗng
    API-->Agent: Response (success: true, expanded_chunks: [])
else Danh sách chunks không rỗng
    API->VS: get_adjacent_chunks(chunks, page_range)
    VS->VS: Khởi tạo và thêm chunks ban đầu vào expanded_chunks
    loop Với mỗi chunk trong chunks ban đầu
        VS->META: Lấy danh sách chunks của file
        META-->VS: file_chunks
        loop Với mỗi chunk trong file_chunks
            VS->VS: Kiểm tra khoảng cách trang <= page_range\nvà thêm vào expanded_chunks nếu hợp lệ
        end
    end
    VS->VS: Sắp xếp và tính toán thống kê
    VS-->API: expanded_chunks
    API->API: Format dữ liệu và thống kê
    API-->Agent: Response (success: true, expanded_chunks, statistics)
end

