title Gửi Câu Hỏi - Sequence Diagram

frame "Gửi Câu Hỏi"
actor User
boundary "Gradio UI" as UI
boundary "ChatSendView (API)" as API
control "NaturalLanguage Processor" as NLP
database "VectorStore (FAISS)" as VS
control "Reranker" as RER
control "LLM Client (Groq)" as LLM
database "Database (MongoDB)" as DB

User->UI: Gửi câu hỏi
UI->API: POST /api/chat/send/\n(message, session_id, selected_file)

API->NLP: get_natural_response(message)
alt Câu hỏi tự nhiên (chào, hello, ...)
    NLP-->API: natural_response
    API->DB: save_chat_message()
    DB-->API: success
    API-->UI: Response (natural_response)
    UI-->User: Hiển thị câu trả lời tự nhiên
else Câu hỏi về tài liệu
    NLP-->API: None
    
    API->VS: get_stats()
    VS-->API: stats
    
    alt Chưa có tài liệu
        API-->UI: "Chưa có tài liệu nào được upload"
        UI-->User: Thông báo lỗi
    else Có tài liệu
        API->VS: search(message, top_k=30, filename)
        VS-->API: search_results
        
        alt Không tìm thấy kết quả
            API->DB: save_chat_message()
            DB-->API: success
            API-->UI: "Không tìm thấy thông tin"
            UI-->User: Thông báo không tìm thấy
        else Tìm thấy kết quả
            API->VS: get_adjacent_chunks(search_results, page_range=2)
            VS-->API: expanded_results
            
            API->RER: rerank(message, expanded_results, top_k=15)
            RER-->API: reranked_results
            
            API->LLM: generate_answer(message, reranked_results)
            note right of LLM: Tạo prompt với context\nvà gọi Groq API
            LLM-->API: answer
            
            API->DB: save_chat_message(user_id, message, answer, selected_file, chat_session_id)
            DB-->API: success
            
            opt Có chat_session_id
                API->DB: update_session(chat_session_id, title=message)
                DB-->API: success
            end
            
            API-->UI: Response (answer)
            UI-->User: Hiển thị câu trả lời
        end
    end
end
end
