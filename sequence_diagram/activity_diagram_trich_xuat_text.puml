@startuml
|Agent (Actor)|
start

:Gửi yêu cầu trích xuất text đến PDFExtractService\nkèm theo đường dẫn file PDF (pdf_path);

|#AntiqueWhite|Hệ thống (System)|
:Nhận yêu cầu trích xuất text từ Agent\nvới đường dẫn file PDF (pdf_path);

:Kiểm tra file tồn tại và định dạng PDF;

if (File hợp lệ?) then (không)
  |#AntiqueWhite|Hệ thống (System)|
  :Hiển thị thông báo lỗi trên Dialog;
  
  :Trả về thông báo lỗi cho Agent;
  
  |Agent (Actor)|
  :Nhận thông báo lỗi từ Hệ thống;
  
  :Tiến hành xử lý lỗi;
  
  stop
  
else (có)
  |#AntiqueWhite|Hệ thống (System)|
  :Gửi yêu cầu trích xuất text tới PDFProcessor\nvới đường dẫn file PDF;
  
  :Gửi yêu cầu đọc file PDF từ File System;
  
  :Nhận dữ liệu file từ File System;
  
  :Mở PDF bằng thư viện fitz (PyMuPDF);
  
  repeat :Duyệt qua từng trang trong PDF;
    |#AntiqueWhite|Hệ thống (System)|
    :Gọi phương thức page.get_text()\nđể trích xuất văn bản từ trang hiện tại;
    
    :Lưu văn bản đã trích xuất\nvào danh sách pages_data;
    
  repeat while (Còn trang chưa xử lý?) is (có)
  ->không;
  
  |#AntiqueWhite|Hệ thống (System)|
  :Đóng file PDF sau khi hoàn tất;
  
  if (Trích xuất thành công?) then (không)
    |#AntiqueWhite|Hệ thống (System)|
    :Phát sinh exception và trả về cho Backend API;
    
    :Hiển thị thông báo lỗi\n"Lỗi khi trích xuất" trên Dialog;
    
    :Trả về thông báo "Lỗi khi trích xuất" cho Agent;
    
    |Agent (Actor)|
    :Nhận thông báo lỗi từ Hệ thống;
    
    :Tiến hành xử lý lỗi;
    
    stop
    
  else (có)
    |#AntiqueWhite|Hệ thống (System)|
    :Tạo danh sách pages_data với format\n[{page_number, text}, ...];
    
    :Format dữ liệu và tính toán thống kê;
    
    :Hiển thị kết quả trích xuất thành công trên Dialog;
    
    :Trả về kết quả thành công kèm theo\npages_data và statistics cho Agent;
    
    |Agent (Actor)|
    :Nhận kết quả thành công từ Hệ thống\nvới pages_data và statistics;
    
    :Tiến hành sử dụng text đã trích xuất\ncho các mục đích tiếp theo\n(lưu trữ, tìm kiếm, phân tích, xử lý ngôn ngữ tự nhiên);
    
    stop
    
  endif
endif

@enduml

