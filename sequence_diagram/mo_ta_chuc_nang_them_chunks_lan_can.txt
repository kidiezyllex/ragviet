Mô tả chức năng: Chức năng thêm chunks từ các trang lân cận cho phép Agent (hệ thống tự động hoặc service xử lý) mở rộng danh sách chunks đã tìm được bằng cách thêm các chunks từ các trang trước và sau trong cùng file PDF. Điều này giúp liên kết nội dung giữa các trang và cung cấp context đầy đủ hơn cho việc tìm kiếm và trả lời câu hỏi. Agent có thể chỉ định số lượng trang lân cận cần lấy (page_range, mặc định là 2 trang trước và sau).
Trình tự thực hiện:
1. Agent gửi yêu cầu thêm chunks lân cận đến AdjacentChunksService (API) kèm theo danh sách chunks ban đầu và page_range (mặc định là 2).
2. Backend API (AdjacentChunksService) tiến hành kiểm tra xem danh sách chunks có rỗng hay không.
Trường hợp 1: Danh sách chunks rỗng
3. Backend API trả về kết quả thành công với danh sách expanded_chunks rỗng cho Agent.
Trường hợp 2: Danh sách chunks không rỗng
3. Backend API gửi yêu cầu lấy chunks lân cận tới VectorStore với danh sách chunks và page_range.
4. VectorStore tiến hành khởi tạo và thêm tất cả chunks ban đầu vào expanded_chunks.
5. VectorStore tiến hành duyệt qua từng chunk trong danh sách chunks ban đầu.
6. Với mỗi chunk, VectorStore gửi yêu cầu lấy danh sách chunks của file từ Metadata Index.
7. Metadata Index trả về danh sách file_chunks (tất cả chunks của file đó) cho VectorStore.
8. VectorStore tiến hành duyệt qua từng chunk trong file_chunks.
9. Với mỗi chunk trong file_chunks, VectorStore kiểm tra khoảng cách trang có nhỏ hơn hoặc bằng page_range và thêm vào expanded_chunks nếu hợp lệ (không phải cùng trang và chưa được thêm).
10. Sau khi duyệt hết tất cả chunks, VectorStore tiến hành sắp xếp expanded_chunks theo thứ tự (filename, page_number, chunk_id) và tính toán thống kê.
11. VectorStore trả về expanded_chunks cho Backend API.
12. Backend API tiến hành format dữ liệu và thống kê.
13. Backend API trả về kết quả thành công với expanded_chunks và statistics cho Agent.
14. Agent tiến hành sử dụng chunks đã mở rộng cho các mục đích tiếp theo.
Kết quả: Quá trình thêm chunks từ các trang lân cận thành công. Agent nhận được danh sách chunks đã được mở rộng với các chunks từ các trang trước và sau, giúp cung cấp context đầy đủ hơn cho việc xử lý và trả lời câu hỏi.
