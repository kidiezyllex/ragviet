@startuml
|Người dùng (Actor)|
start

:Nhập câu hỏi vào Form Chat;

:Nhấn nút Gửi câu hỏi;

|#AntiqueWhite|Hệ thống (System)|
:Nhận yêu cầu POST từ Frontend;

:Kiểm tra câu hỏi có phải câu hỏi tự nhiên\n(chào hỏi, giới thiệu) không?;

if (Câu hỏi tự nhiên?) then (có)
  |#AntiqueWhite|Hệ thống (System)|
  :Nhận câu trả lời tự nhiên từ\nNaturalLanguage Processor;
  
  :Lưu câu hỏi và câu trả lời vào Database;
  
  :Trả về câu trả lời tự nhiên cho Frontend;
  
  |Người dùng (Actor)|
  :Nhận và xem câu trả lời tự nhiên\nhiển thị trên Form Chat;
  
  stop
  
else (không)
  |#AntiqueWhite|Hệ thống (System)|
  :Kiểm tra số lượng tài liệu đã upload\ntrong VectorStore;
  
  if (Có tài liệu?) then (không)
    |#AntiqueWhite|Hệ thống (System)|
    :Hiển thị thông báo lỗi\n"Chưa có tài liệu nào được upload" trên Dialog;
    
    :Trả về thông báo lỗi cho Frontend;
    
    |Người dùng (Actor)|
    :Nhận và xem thông báo lỗi\nhiển thị trên Dialog;
    
    stop
    
  else (có)
    |#AntiqueWhite|Hệ thống (System)|
    :Gửi truy vấn tìm kiếm tới VectorStore\nvới câu hỏi, top_k=30 và filename (nếu có);
    
    :Nhận kết quả tìm kiếm từ VectorStore;
    
    if (Tìm thấy kết quả?) then (không)
      |#AntiqueWhite|Hệ thống (System)|
      :Lưu câu hỏi và thông báo\n"Không tìm thấy thông tin" vào Database;
      
      :Hiển thị thông báo "Không tìm thấy thông tin" trên Form Chat;
      
      :Trả về thông báo "Không tìm thấy thông tin" cho Frontend;
      
      |Người dùng (Actor)|
      :Nhận và xem thông báo không tìm thấy\nhiển thị trên Form Chat;
      
      stop
      
    else (có)
      |#AntiqueWhite|Hệ thống (System)|
      :Gửi yêu cầu lấy các chunks liên quan\n(adjacent chunks) từ VectorStore\nvới page_range=2;
      
      :Nhận danh sách chunks đã mở rộng\n(expanded_results) từ VectorStore;
      
      :Gửi yêu cầu rerank kết quả tìm kiếm\ntới Reranker với top_k=15;
      
      :Nhận danh sách kết quả đã được sắp xếp lại\n(reranked_results) từ Reranker;
      
      :Gửi yêu cầu sinh câu trả lời tới LLM Client\n(Groq) kèm câu hỏi và các chunks đã rerank;
      
      :Tạo prompt với context từ các chunks\nvà gọi Groq API để sinh câu trả lời;
      
      :Nhận câu trả lời (answer) từ LLM Client;
      
      :Lưu câu hỏi, câu trả lời và thông tin liên quan\n(user_id, selected_file, chat_session_id) vào Database;
      
      if (Có chat_session_id?) then (có)
        |#AntiqueWhite|Hệ thống (System)|
        :Cập nhật tiêu đề session với nội dung câu hỏi\nvào Database;
        
      endif
      
      |#AntiqueWhite|Hệ thống (System)|
      :Hiển thị câu trả lời đầy đủ trên Form Chat;
      
      :Trả về câu trả lời đầy đủ cho Frontend;
      
      |Người dùng (Actor)|
      :Nhận và xem câu trả lời\nhiển thị trên Form Chat;
      
      stop
      
    endif
  endif
endif

@enduml

